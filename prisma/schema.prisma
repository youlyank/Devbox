// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String?
  avatar            String?
  subscriptionTier  String    @default("free") // free, pro, business, enterprise
  subscriptionEnds  DateTime?
  stripeCustomerId  String?   @unique
  stripeSubscriptionId String? @unique
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  projects          Project[]
  billing           Billing?
  usageLogs         UsageLog[]
  projectVersions   ProjectVersion[]
  collaborations    Collaboration[]
  sessions          Session[]
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  isPublic    Boolean  @default(false)
  status      String   @default("draft") // draft, deployed, archived
  config      Json     // Project configuration and workflow JSON
  subdomain   String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deployments Deployment[]
  workflows   Workflow[]
  conversations Conversation[]
  versions    ProjectVersion[]
  collaborations Collaboration[]
  sessions    ProjectSession[]
  activeSessions Session[]
}

model ProjectVersion {
  id          String   @id @default(cuid())
  projectId   String
  version     String
  config      Json     // Complete project configuration at this version
  changes     Json?    // Diff from previous version
  message     String?  // Commit message
  userId      String   // Who created this version
  createdAt   DateTime @default(now())
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, version])
}

model Collaboration {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  role        String   @default("viewer") // viewer, editor, admin
  lastActive  DateTime @default(now())
  cursor      Json?    // Current cursor position
  createdAt   DateTime @default(now())
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, userId])
}

model Session {
  id          String   @id @default(cuid())
  userId      String
  socketId    String   @unique
  projectId   String?
  isActive    Boolean  @default(true)
  lastSeen    DateTime @default(now())
  metadata    Json?    // User agent, IP, etc.
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

model ProjectSession {
  id          String   @id @default(cuid())
  projectId   String
  sessionId   String
  isActive    Boolean  @default(true)
  data        Json?    // Real-time collaboration data
  createdAt   DateTime @default(now())
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Workflow {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  description String?
  nodes       Json     // React Flow nodes configuration
  edges       Json     // React Flow edges configuration
  blocks      Json     // Block configurations
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Deployment {
  id            String   @id @default(cuid())
  projectId     String
  version       String
  url           String?
  subdomain     String?
  status        String   @default("pending") // pending, building, running, stopped, error
  containerId   String?
  containerName String?
  dockerImage   String?
  config        Json     // Deployment configuration
  environment   Json?    // Environment variables
  resources     Json?    // CPU, Memory limits
  metrics       Json?    // Real-time metrics
  logs          String?  // Container logs
  startedAt     DateTime?
  stoppedAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  usageLogs     UsageLog[]
}

model Billing {
  id                String   @id @default(cuid())
  userId            String   @unique
  tier              String   @default("free")
  status            String   @default("active") // active, cancelled, suspended
  currentPeriodEnd  DateTime
  amount            Float
  currency          String   @default("USD")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UsageLog {
  id            String   @id @default(cuid())
  userId        String
  deploymentId  String?
  type          String   // cpu, memory, storage, requests, ai_request, bandwidth
  amount        Float
  unit          String   // hours, mb, gb, requests, tokens, seconds
  cost          Float
  metadata      Json?    // Additional details (model used, endpoint, etc.)
  timestamp     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deployment    Deployment? @relation(fields: [deploymentId], references: [id], onDelete: SetNull)
}

model Conversation {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  title       String?
  messages    Json     // Array of conversation messages
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}